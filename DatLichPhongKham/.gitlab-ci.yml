stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  COMPOSE_PROJECT_NAME: datlichphongkham
  GIT_STRATEGY: clone
  GIT_DEPTH: 0

# Job Build
build_job:
  stage: build
  tags:
    - local
  before_script:
    - echo "===== CHECKING ENVIRONMENT ====="
    - Write-Output "Current directory: $(Get-Location)"
    - Write-Output "===== LISTING FILES ====="
    - Get-ChildItem | Select-Object Name
    - Write-Output "===== CHECKING FOR POM.XML ====="
    - if (Test-Path "pom.xml") {
        Write-Output "✅ pom.xml found in root"
      } elseif (Test-Path "DatLichPhongKham/pom.xml") {
        Write-Output "✅ pom.xml found in DatLichPhongKham/"
        Set-Location "DatLichPhongKham"
        Write-Output "Changed to: $(Get-Location)"
      } else {
        Write-Output "❌ pom.xml NOT FOUND"
        Write-Output "Searching recursively..."
        $found = Get-ChildItem -Recurse -Filter pom.xml -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($found) {
          Write-Output "✅ Found at: $($found.FullName)"
          Set-Location (Split-Path -Parent $found.FullName)
        } else {
          Write-Output "❌ pom.xml NOT FOUND anywhere!"
          Write-Output "Git files:"
          git ls-files | Select-String pom
          exit 1
        }
      }
    - Write-Output "===== FINAL VERIFICATION ====="
    - Write-Output "Current directory: $(Get-Location)"
    - if (Test-Path "pom.xml") {
        Write-Output "✅ pom.xml verified: $(Resolve-Path pom.xml)"
      } else {
        Write-Output "❌ pom.xml verification FAILED!"
        exit 1
      }
  script:
    - echo "===== BUILD PROJECT ====="
    - Write-Output "Building in: $(Get-Location)"
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - "target/*.jar"
    expire_in: 1 hour

# Job Test
test_job:
  stage: test
  tags:
    - local
  before_script:
    - if (Test-Path "pom.xml") {
        Write-Output "pom.xml in root"
      } elseif (Test-Path "DatLichPhongKham/pom.xml") {
        Set-Location "DatLichPhongKham"
      } else {
        $found = Get-ChildItem -Recurse -Filter pom.xml -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($found) {
          Set-Location (Split-Path -Parent $found.FullName)
        }
      }
  script:
    - echo "===== RUN TESTS ====="
    - mvn test

# Job Deploy
deploy_job:
  stage: deploy
  tags:
    - local
  only:
    - main
    - master
  script:
    - echo "===== RESTARTING CONTAINERS ====="
    - docker-compose down
    - docker-compose up -d --build
    - Start-Sleep -Seconds 10
    - docker ps -a
