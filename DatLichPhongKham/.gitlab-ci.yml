stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  COMPOSE_PROJECT_NAME: datlichphongkham
  # ... (gi·ªØ nguy√™n c√°c variables kh√°c c·ªßa b·∫°n)

# Job Build
build_job:
  stage: build
  tags:
    - local
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - echo "===== CHECKING ENVIRONMENT ====="
    - pwd
    - echo "===== LISTING ROOT FILES ====="
    - Get-ChildItem -Force | Select-Object Name, Length
    - echo "===== SEARCHING FOR POM.XML ====="
    - $pomPath = $null
    - # T√¨m pom.xml trong root tr∆∞·ªõc
    - if (Test-Path "pom.xml") {
        $pomPath = (Resolve-Path "pom.xml").Path
        Write-Output "‚úÖ Found pom.xml in root: $pomPath"
      }
    - # N·∫øu kh√¥ng c√≥, t√¨m trong subdirectories
    - if (-not $pomPath) {
        Write-Output "Searching in subdirectories..."
        $pomPath = Get-ChildItem -Recurse -Filter pom.xml -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($pomPath) {
          Write-Output "‚úÖ Found pom.xml at: $pomPath"
        }
      }
    - # Ki·ªÉm tra DatLichPhongKham/ subdirectory (c·∫•u tr√∫c tr√™n GitLab)
    - if (-not $pomPath -and (Test-Path "DatLichPhongKham")) {
        Write-Output "Checking DatLichPhongKham subdirectory..."
        if (Test-Path "DatLichPhongKham/pom.xml") {
          $pomPath = (Resolve-Path "DatLichPhongKham/pom.xml").Path
          Write-Output "‚úÖ Found pom.xml in DatLichPhongKham/: $pomPath"
        }
      }
    - # N·∫øu t√¨m th·∫•y, cd v√†o th∆∞ m·ª•c ƒë√≥
    - if ($pomPath) {
        $pomDir = Split-Path -Parent $pomPath
        Write-Output "üìÅ pom.xml directory: $pomDir"
        Write-Output "üìÅ Current directory: $(Get-Location)"
        if ($pomDir -ne (Get-Location).Path) {
          Write-Output "üîÑ Changing to pom.xml directory..."
          Set-Location $pomDir
          Write-Output "‚úÖ Changed to: $(Get-Location)"
        }
      } else {
        Write-Output "‚ùå pom.xml NOT FOUND anywhere!"
        Write-Output "Checking git files..."
        git ls-files | Select-String pom
        Write-Output "Checking git tree..."
        git ls-tree -r HEAD --name-only | Select-String pom
        Write-Output "Forcing git checkout..."
        git checkout -f HEAD
        git reset --hard HEAD
        # Th·ª≠ l·∫°i sau checkout
        if (Test-Path "pom.xml") {
          $pomPath = (Resolve-Path "pom.xml").Path
        } elseif (Test-Path "DatLichPhongKham/pom.xml") {
          $pomPath = (Resolve-Path "DatLichPhongKham/pom.xml").Path
          Set-Location "DatLichPhongKham"
        } else {
          Write-Output "‚ùå pom.xml still NOT FOUND after checkout!"
          exit 1
        }
      }
    - echo "===== VERIFYING POM.XML ====="
    - if (Test-Path pom.xml) {
        Write-Output "‚úÖ pom.xml verified at: $(Resolve-Path pom.xml)"
        Get-Item pom.xml | Select-Object FullName, Length
      } else {
        Write-Output "‚ùå pom.xml verification failed!"
        Write-Output "Current directory: $(Get-Location)"
        Write-Output "Files in current directory:"
        Get-ChildItem | Select-Object Name
        exit 1
      }
  script:
    - echo "===== BUILD PROJECT ====="
    - echo "Current directory: $(Get-Location)"
    - echo "POM file: $(Resolve-Path pom.xml)"
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - "target/*.jar"
    expire_in: 1 hour

# Job Test
test_job:
  stage: test
  tags:
    - local
  before_script:
    - $pomPath = $null
    - if (Test-Path "pom.xml") {
        $pomPath = (Resolve-Path "pom.xml").Path
      } elseif (Test-Path "DatLichPhongKham/pom.xml") {
        $pomPath = (Resolve-Path "DatLichPhongKham/pom.xml").Path
        Set-Location "DatLichPhongKham"
      } else {
        $pomPath = Get-ChildItem -Recurse -Filter pom.xml -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if ($pomPath) {
          $pomDir = Split-Path -Parent $pomPath
          Set-Location $pomDir
        }
      }
  script:
    - echo "===== RUN TESTS ====="
    - mvn test

# Job Deploy
deploy_job:
  stage: deploy
  tags:
    - local
  only:
    - main
  script:
    - echo "===== RESTARTING CONTAINERS ====="
    - docker-compose down
    - docker-compose up -d --build
    - Start-Sleep -Seconds 10
    - docker ps -a